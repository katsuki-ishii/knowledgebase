---
base: "[[CS.Software_Engineering.base]]"
作成者: Katsubo Katsubo
カテゴリー:
  - CS
作成日時: 2026-02-09T12:00:00
aliases: [冪等性, Idempotency, idempotency, 冪等]
---

# [[冪等性|冪等性]]（[[冪等性|Idempotency]]）

## 1. [[冪等性]]とは

[[冪等性]]とは、**同じ操作を何度実行しても、結果（最終状態）が同じになる性質**を指す。

重要なのは「初回に変化があるかどうか」ではなく、**2回目以降に結果が変わるかどうか**である。

---

## 2. [[基礎 Part 21 副作用と純粋関数|副作用]]との違い

- [[基礎 Part 21 副作用と純粋関数|副作用]]がある = [[冪等性|冪等]]でない、ではない。
- [[基礎 Part 21 副作用と純粋関数|副作用]]があっても、結果が固定されるなら[[冪等性|冪等]]である。

### 具体例：DELETE

- 1回目：リソースが削除される（[[基礎 Part 21 副作用と純粋関数|副作用]]あり）。
- 2回目：すでに存在しないため何も起きない。

最終状態は常に「存在しない」ため、DELETE は[[冪等性|冪等]]である。

---

## 3. 状態ベースと[[基礎 Part 15 イベントオブジェクト|イベント]]ベース

[[冪等性]]の本質は、**あるリソース A を常に一意に指定し、その A の状態を指定すること**にある。

重要なのは「何をするか」ではなく、**「どのリソースを、どの状態にするか」**である。

---

### 状態ベース（[[冪等性|冪等]]）

対象となるリソース A を固定し、その状態を明示的に指定する。

```
A: ○
↓
A: ×
```

この操作を何回実行しても、最終状態は常に次の通りになる。

```
A: ×
```

#### 具体例

- ユーザー A の active を false にする。
- [[Task|タスク]] A の state を completed にする。

これらは「A をこの状態にせよ」という命令であり、回数に意味がない。

---

### [[基礎 Part 15 イベントオブジェクト|イベント]]ベース（非[[冪等性|冪等]]）

対象リソースは同じでも、「状態指定」ではなく「変化を起こす」操作。

```
A --(+100)--> A'
A' --(+100)--> A''
```

実行回数が結果に影響する。

#### 具体例

- ユーザー A のポイントを +100 する。
- 注文を 1 件作成する。
- メールを 1 通送信する。

---

### [[基礎 Part 15 イベントオブジェクト|イベント]]ベース（非[[冪等性|冪等]]）— 「1回起こす」操作

「何かを 1 回起こす」という考え方。

```
A --(イベント)--> A'
A' --(イベント)--> A''
```

実行回数が結果に影響する。

#### 具体例

- ポイントを +100 する。
- 注文を作成する。
- メールを送信する。

---

## 4. HTTPメソッドと[[冪等性]]

| メソッド | [[冪等性]] | 説明 |
| -------- | ------ | ---- |
| [[HTTPメソッド GET|GET]] | [[冪等性|冪等]] | 取得のみで状態を変えない |
| PUT | [[冪等性|冪等]] | 状態を指定して更新する |
| DELETE | [[冪等性|冪等]] | 削除後は同じ状態に留まる |
| POST | 非[[冪等性|冪等]] | 実行ごとに新しい結果が生まれる |

---

## 5. PUT と POST の違い（具体例）

### PUT（[[冪等性|冪等]]）

```
PUT /users/1
{
  "name": "Taro"
}
```

何回呼んでも「ユーザー 1 の名前は Taro」という状態になる。

---

### POST（非[[冪等性|冪等]]）

```
POST /orders
```

- 1 回目：注文 1 件作成。
- 2 回目：注文 2 件作成。

回数に意味があるため非[[冪等性|冪等]]である。

---

## 6. [[冪等性]]が活きる場面

### (1) 通信の再送

- 通信エラー。
- ユーザーの再送信。
- ブラウザのリロード。

同じリクエストが複数回来る前提で設計する必要がある。

---

### (2) 自動リトライ

- API Gateway。
- SDK の自動リトライ。
- Lambda の再実行。

人間が意図していなくても処理が再実行される。

---

### (3) 分散システム

```
クライアント
   |
   | リクエスト
   v
Lambda ---- DB更新完了
   |
   | タイムアウト
   v
再実行（同じ処理）
```

[[冪等性|冪等]]でないと、二重更新や二重処理が発生する。

---

## 7. 実務での判断基準

次の質問に「問題ない」と答えられるか。

- 同じリクエストが 3 回来たらどうなるか。
- 成功したか分からず再送されたらどうなるか。
- 処理途中で再実行されたらどうなるか。

問題が起きるなら、[[冪等性]]を疑う。

---

## 8. 本質的なまとめ

- [[冪等性]]は安全設計のための概念である。
- Web は「正確に 1 回実行できる」世界ではない。
- 状態ベースで設計すると[[冪等性|冪等]]になりやすい。
- [[冪等性]]は障害・再送・再実行に耐えるための保険である。

[[冪等性]]を意識できると、API 設計・DB 設計・クラウド設計が一段上の視点で見えるようになる。
