---
base: "[[ナレッジベース.base]]"
作成者: Katsubo Katsubo
カテゴリー:
  - CS
作成日時: 2025-08-10T16:51:00
---
# IPsecの概要

- **IP Security（IPsec）**: ネットワーク層で通信を暗号化・認証・改ざん検知するプロトコル群。
    - **ネットワーク層**: OSI参照モデルの第3層。例: 社内PCから本社サーバへIPアドレス経由でデータを送る層。
- 主な役割
    1. **暗号化（Confidentiality）**: 第三者が通信内容を読めないようにする（例: 社内資料を外部の誰かに盗み見られないようにする）。
    2. **認証（Authentication）**: 通信相手が正しい相手か確認する（例: 接続先が本当に自社の拠点か確認）。
    3. **改ざん検知（Integrity）**: データが途中で変更されていないか確認する（例: 送信した請求書の金額が途中で書き換えられていないかチェック）。

## モード

- **トンネルモード**: IPパケット全体を暗号化し、新しいIPヘッダを付与。拠点間VPN向け。
    - 例: 東京本社と大阪支社のルータ間で全社内通信を暗号化。
    - **IPパケット**: IPヘッダ＋データ部分（ペイロード）で構成される通信単位。
- **トランスポートモード**: ペイロード部分のみ暗号化。端末間通信向け。
    - 例: 社内のPCからサーバへ直接暗号化通信。
    - **ペイロード**: パケットの中身のデータ部分。

## 関連プロトコル

- **AH (Authentication Header)**: 認証と改ざん検知を提供。暗号化はしない。
- **ESP (Encapsulating Security Payload)**: 暗号化と改ざん検知を両方提供。実務ではほぼESP。
- **IKE (Internet Key Exchange)**: 鍵交換プロトコル。フェーズ1で安全チャネル、フェーズ2でデータ用鍵を確立。
    - 例: 東京と大阪のルータが暗号鍵を安全に共有するための手順。
    - **鍵交換**: 暗号化・復号に使う共通鍵を安全にやり取りする仕組み。

## ESPの暗号化プロセス

1. 暗号化対象のペイロードを抽出（トンネルモードなら元IPヘッダごと）。
2. AESや3DESなどの**暗号化アルゴリズム**で暗号化。
3. **ESPヘッダ**（SPI: Security Parameters Index、シーケンス番号）を追加。
4. **ESPトレーラ**（パディング、次のヘッダ情報）を追加。
5. **認証データ**（HMACで計算）を追加して改ざん検知。
6. 受信側はHMACで改ざん検知→復号→元パケット再構築。
- **HMAC**: 秘密鍵とハッシュ関数を組み合わせた改ざん検知用の仕組み。
- 具体例: 郵便物の封に特殊な印鑑を押して、開封・改ざんがないか確認するイメージ。

## AES暗号化の特徴

- **共通鍵暗号方式**: 暗号化と復号で同じ鍵を使う（例: 同じ鍵穴の金庫を2人がそれぞれ開け閉めする）。
- **ブロック暗号**: 一定サイズ（128ビット）のデータ単位ごとに暗号化。
- 鍵長: 128 / 192 / 256ビット。
- モード例:
    - **CBC（Cipher Block Chaining）**: 前の暗号ブロックと混ぜて次を暗号化。
    - **GCM（Galois/Counter Mode）**: 高速で並列処理可能、改ざん検知機能も付属。

## VPNで遅くなる主な原因

7. 暗号化処理のCPU負荷（暗号化アクセラレータ未使用）。
8. 重い暗号方式（AES-256-CBCなど）。
9. MTU超過による断片化・再送。
10. 経路の迂回（VPNゲートウェイ位置による）。
11. 回線やQoS制限。
- **MTU（Maximum Transmission Unit）**: 一度に送れる最大データサイズ（例: 大きすぎる荷物は分割して送る必要がある）。
- **QoS（Quality of Service）**: 通信の優先度や帯域を制御する仕組み（例: 緊急車両を優先的に通す道路）。

## VPNルータの通信経路について

- **VPNルータ**は、VPN接続の有無にかかわらず、通常その拠点やネットワークの出口として使われる。
- **VPN接続時**: VPNルータは暗号化（IPsecなど）を行い、データをVPNトンネルに送る。
    - 例: 東京の拠点ルータが大阪の拠点ルータにIPsecトンネルでデータを送る。
- **VPN未接続時**: 同じルータを通るが、暗号化せずに通常のインターネットルーティングとして通信を処理。
    - 例: 社内PCからインターネットのWebサイトへアクセスするときは暗号化されず、そのまま外部に転送される。
- 実務では、ルータがVPN用と通常インターネット用の両方の経路を持ち、宛先によって使い分ける設定（ルーティング）がされていることが多い。